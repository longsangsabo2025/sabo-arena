name: ğŸ¤– Android Play Store Deployment - FOCUS MODE

on:
  push:
    branches: [ main ]
  workflow_dispatch:   # Manual trigger for Play Store

env:
  FLUTTER_VERSION: '3.35.2'
  JAVA_VERSION: '17'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  # ========== ANDROID BUILD & DEPLOY ==========
  build-android:
    name: ğŸ¤– Build & Deploy Android
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'zulu'
        
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    # ========== VERIFY SETUP ==========
    - name: ğŸ” Verify Android Setup
      run: |
        echo "ğŸ¤– Android Deployment Configuration:"
        echo "âœ… Java Version: ${{ env.JAVA_VERSION }}"
        echo "âœ… Flutter Version: ${{ env.FLUTTER_VERSION }}"
        echo "âœ… Ready for Play Store deployment!"
        echo "ğŸ”§ Building with Supabase integration"
        
    # ========== ANDROID KEYSTORE SETUP ==========
    - name: ğŸ” Setup Android Keystore
      run: |
        # Create Android directory if it doesn't exist
        mkdir -p android/app
        
        echo "ğŸ”§ Decoding Android keystore..."
        echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/keystore.jks
        
        echo "ğŸ”§ Creating key.properties..."
        cat > android/key.properties << EOF
        storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
        keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
        storeFile=keystore.jks
        EOF
        
        # Verify keystore file was created
        echo "ğŸ“ Keystore files:"
        ls -la android/app/keystore.jks
        ls -la android/key.properties
        
        echo "âœ… Android keystore setup completed"
        
    # ========== PLAY STORE API SETUP ==========
    - name: ğŸ”‘ Setup Play Store API
      run: |
        # Create API key directory
        mkdir -p ~/.config/gcloud
        
        echo "ğŸ”§ Decoding Play Store service account key..."
        echo "${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON_BASE64 }}" | base64 -d > ~/.config/gcloud/service-account-key.json
        
        # Verify API key file was created
        echo "ğŸ“ Service account key:"
        ls -la ~/.config/gcloud/service-account-key.json
        
        echo "âœ… Play Store API setup completed"
        
    # ========== ANDROID BUILD ==========
    - name: ğŸ—ï¸ Build Android AAB
      run: |
        echo "ğŸ—ï¸ Building Android App Bundle with Supabase configuration..."
        flutter build appbundle --release \
          --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
          --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        echo "âœ… Android AAB build completed"
        
    - name: ğŸ—ï¸ Build Android APK (Optional)
      run: |
        echo "ğŸ—ï¸ Building Android APK for testing..."
        flutter build apk --release \
          --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
          --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        echo "âœ… Android APK build completed"
        
    # ========== VERIFY SIGNED AAB ==========
    - name: âœ… Verify Signed AAB
      run: |
        echo "ğŸ” Verifying signed AAB..."
        file build/app/outputs/bundle/release/app-release.aab
        ls -la build/app/outputs/bundle/release/
        echo "âœ… AAB verification completed"
        
    # ========== DEPLOY TO PLAY STORE ==========
    - name: ğŸš€ Deploy to Play Store Internal Testing
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: r0adkll/upload-google-play@v1.1.3
      with:
        serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
        packageName: com.sabo_arena.app
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        inAppUpdatePriority: 0
        userFraction: 1.0
        whatsNewDirectory: android/release-notes/
        mappingFile: build/app/outputs/mapping/release/mapping.txt
        
    # ========== UPLOAD ARTIFACTS ==========
    - name: ğŸ“¦ Upload AAB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-aab
        path: build/app/outputs/bundle/release/app-release.aab
        
    - name: ğŸ“¦ Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk
        
    - name: ğŸ“¦ Upload Mapping File
      uses: actions/upload-artifact@v4
      with:
        name: android-mapping
        path: build/app/outputs/mapping/release/mapping.txt
        
    # ========== CLEANUP ==========
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        # Remove sensitive files safely
        rm -f android/app/keystore.jks || true
        rm -f android/key.properties || true
        rm -f ~/.config/gcloud/service-account-key.json || true
        
    # ========== NOTIFICATIONS ==========
    - name: ğŸ“¢ Notify Success
      if: success() && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/'))
      run: |
        echo "ğŸ‰ Android deployment successful!"
        echo "ğŸ“± Check Play Console: https://play.google.com/console/"
        
    - name: ğŸ“¢ Notify Failure
      if: failure()
      run: |
        echo "âŒ Android deployment failed!"
        echo "ğŸ” Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  # ========== NOTIFICATION JOB ==========
  notify:
    name: ğŸ“¢ Send Notifications  
    needs: [build-android]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“± Deployment Status
      run: |
        if [[ "${{ needs.build-android.result }}" == "success" ]]; then
          echo "âœ… SABO ARENA Android deployment completed successfully!"
          echo "ğŸ“± New build available in Play Console Internal Testing"
          echo "ğŸ”— Play Console: https://play.google.com/console/"
        else
          echo "âŒ SABO ARENA Android deployment failed"
          echo "ğŸ” Check workflow logs for details"
        fi