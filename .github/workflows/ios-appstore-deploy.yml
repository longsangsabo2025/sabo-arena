name: ğŸ iOS App Store Deploy (Optimized)

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      deploy_to_testflight:
        description: 'Deploy to TestFlight?'
        required: true
        default: 'true'
        type: boolean

env:
  FLUTTER_VERSION: '3.35.2'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

jobs:
  deploy-ios:
    name: ğŸ Build & Deploy iOS to App Store
    runs-on: macos-13  # Sá»­ dá»¥ng macOS 13 vá»›i Xcode 15
    timeout-minutes: 60
    
    steps:
    # ========== CHECKOUT ==========
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper versioning
    
    # ========== FLUTTER SETUP ==========
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true
        
    - name: ğŸ“‹ Flutter Doctor
      run: |
        flutter --version
        flutter doctor -v
    
    # ========== DEPENDENCIES ==========
    - name: ğŸ“¦ Install Dependencies
      run: |
        flutter pub get
        flutter pub upgrade
    
    # ========== CODE QUALITY ==========
    - name: ğŸ” Analyze Code
      run: flutter analyze --no-fatal-infos
      
    - name: ğŸ§ª Run Tests
      run: flutter test || echo "âš ï¸ Tests failed but continuing..."
      continue-on-error: true
    
    # ========== IOS SETUP ==========
    - name: ğŸ” Setup iOS Certificates & Provisioning
      run: |
        echo "ğŸ”§ Setting up iOS signing..."
        
        # Create directories
        mkdir -p ~/certificates
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        mkdir -p ~/private_keys
        
        # Decode and save certificate
        echo "ğŸ“œ Decoding distribution certificate..."
        echo "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_BASE64 }}" | base64 --decode > ~/certificates/distribution.p12
        
        # Decode and save provisioning profile
        echo "ğŸ“„ Decoding provisioning profile..."
        echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/certificates/app.mobileprovision
        
        # Decode and save API key
        echo "ğŸ”‘ Decoding App Store Connect API key..."
        echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}.p8
        
        # Verify files
        echo "âœ… Verifying certificate files..."
        ls -lh ~/certificates/
        ls -lh ~/private_keys/
        
        # Create keychain
        echo "ğŸ” Creating build keychain..."
        security create-keychain -p "build-password" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "build-password" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Import certificate
        echo "ğŸ“¥ Importing certificate to keychain..."
        security import ~/certificates/distribution.p12 \
          -k build.keychain \
          -P "${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}" \
          -T /usr/bin/codesign \
          -T /usr/bin/security \
          -A
        
        # Set key partition list
        security set-key-partition-list -S apple-tool:,apple: -s -k "build-password" build.keychain
        
        # Install provisioning profile
        echo "ğŸ“² Installing provisioning profile..."
        UUID=$(grep UUID -A1 -a ~/certificates/app.mobileprovision | grep -io "[-A-F0-9]\{36\}")
        cp ~/certificates/app.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
        
        echo "âœ… iOS setup completed!"
        
        # List available certificates
        echo "ğŸ“‹ Available signing identities:"
        security find-identity -v -p codesigning
    
    # ========== CREATE EXPORT OPTIONS ==========
    - name: ğŸ“„ Create ExportOptions.plist
      run: |
        cat > ios/ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ env.APPLE_TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>destination</key>
            <string>upload</string>
            <key>manageAppVersionAndBuildNumber</key>
            <false/>
        </dict>
        </plist>
        EOF
        
        echo "âœ… ExportOptions.plist created"
        cat ios/ExportOptions.plist
    
    # ========== BUILD IOS ==========
    - name: ğŸ—ï¸ Build iOS App
      run: |
        echo "ğŸ—ï¸ Building iOS app for release..."
        flutter build ios \
          --release \
          --no-codesign \
          --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
          --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        
        echo "âœ… Flutter build completed"
        
    # ========== ARCHIVE & EXPORT ==========
    - name: ğŸ“¦ Archive & Export IPA
      run: |
        cd ios
        
        echo "ğŸ“¦ Creating archive..."
        xcodebuild \
          -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath build/Runner.xcarchive \
          clean archive \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="" \
          DEVELOPMENT_TEAM="${{ env.APPLE_TEAM_ID }}" | xcpretty || true
        
        echo "âœ… Archive created"
        
        echo "ğŸ“¤ Exporting IPA..."
        xcodebuild \
          -exportArchive \
          -archivePath build/Runner.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates | xcpretty || true
        
        echo "âœ… IPA exported"
        
        # List output files
        ls -lh build/ipa/
        
    # ========== VALIDATE IPA ==========
    - name: âœ… Validate IPA
      run: |
        echo "ğŸ” Validating IPA..."
        if [ -f "ios/build/ipa/Runner.ipa" ]; then
          IPA_SIZE=$(du -h ios/build/ipa/Runner.ipa | cut -f1)
          echo "âœ… IPA file exists: $IPA_SIZE"
          
          # Unzip and check contents
          unzip -l ios/build/ipa/Runner.ipa | head -20
        else
          echo "âŒ IPA file not found!"
          exit 1
        fi
    
    # ========== UPLOAD TO TESTFLIGHT ==========
    - name: ğŸš€ Upload to TestFlight
      if: |
        github.ref == 'refs/heads/main' || 
        startsWith(github.ref, 'refs/tags/v') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_to_testflight == 'true')
      run: |
        echo "ğŸš€ Uploading to App Store Connect..."
        
        # Use xcrun altool for upload
        xcrun altool \
          --upload-app \
          --type ios \
          --file "ios/build/ipa/Runner.ipa" \
          --apiKey "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
          --apiIssuer "${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}" \
          --verbose
        
        echo "âœ… Upload to TestFlight completed!"
        echo "ğŸ“± Check status at: https://appstoreconnect.apple.com"
    
    # ========== UPLOAD ARTIFACTS ==========
    - name: ğŸ“¦ Upload Build Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.run_number }}
        path: |
          ios/build/ipa/*.ipa
          ios/build/Runner.xcarchive
        retention-days: 30
    
    # ========== UPLOAD DSYMS ==========
    - name: ğŸ“Š Upload dSYMs
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: ios-dsyms-${{ github.run_number }}
        path: ios/build/Runner.xcarchive/dSYMs
        retention-days: 90
    
    # ========== CLEANUP ==========
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up sensitive files..."
        rm -rf ~/certificates || true
        rm -rf ~/private_keys || true
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision || true
        security delete-keychain build.keychain 2>/dev/null || true
        echo "âœ… Cleanup completed"
    
    # ========== SUMMARY ==========
    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        echo "## ğŸ iOS Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Flutter Version:** ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“± Check TestFlight: [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Status:** Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ” Review the logs above for details" >> $GITHUB_STEP_SUMMARY
        fi

  # ========== NOTIFICATION ==========
  notify:
    name: ğŸ“¢ Notify Results
    needs: [deploy-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“± Deployment Status
      run: |
        if [ "${{ needs.deploy-ios.result }}" == "success" ]; then
          echo "âœ… SABO ARENA iOS deployment successful!"
          echo "ğŸ“± Build number: ${{ github.run_number }}"
          echo "ğŸ”— TestFlight: https://appstoreconnect.apple.com"
          echo "ğŸ“¦ Artifacts available in workflow run"
        else
          echo "âŒ SABO ARENA iOS deployment failed"
          echo "ğŸ” Check workflow logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        fi
