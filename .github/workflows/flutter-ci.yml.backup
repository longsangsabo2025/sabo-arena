name: ğŸš€ SaboArena CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'  # Trigger on version tags
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

env:
  FLUTTER_VERSION: '3.35.2'
  # Supabase config for all builds
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}

jobs:
  # ========== CI PHASE ==========
  test:
    name: ğŸ§ª Test & Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    # - name: ğŸ” Analyze Code
    #   run: flutter analyze
      
    # - name: ğŸ“ Check Formatting
    #   run: dart format --set-exit-if-changed .
      
    - name: ğŸ§ª Run Unit Tests
      run: flutter test --coverage
      
    - name: ğŸ“Š Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        
  # ========== BUILD PHASE ==========
  build-android:
    name: ğŸ¤– Build Android
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build APK (Debug)
      run: flutter build apk --debug
      
    - name: ğŸ—ï¸ Build APK (Release)
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      run: flutter build apk --release \
        --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
        --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        
    - name: ğŸ“¦ Upload APK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/
        
  build-ios:
    name: ğŸ Build iOS
    needs: test
    runs-on: macos-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build iOS (No Codesign)
      run: flutter build ios --release --no-codesign \
        --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
        --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        
  # ========== DEPLOY PHASE ==========
  deploy-internal:
    name: ğŸš€ Deploy to Internal Testing
    needs: [test, build-android]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ” Setup Android Signing
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
        echo "storeFile=keystore.jks" >> android/key.properties
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build AAB for Play Store
      run: flutter build appbundle --release \
        --dart-define=SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
        --dart-define=SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        
    - name: ğŸ“± Upload to Google Play Internal Testing
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.sabo_arena.app
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        
  # ========== DEPLOYMENT PHASE ==========
  deploy-alpha:
    name: ğŸ§ª Deploy to Alpha Testing
    needs: [test, build-android]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || contains(github.ref, 'alpha')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build APK for Alpha
      run: flutter build apk --release \
        --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
        --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        
    - name: ğŸ§ª Upload to Google Play Alpha
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: com.sabo_arena.app
        releaseFiles: build/app/outputs/flutter-apk/app-release.apk
        track: alpha
        status: completed
        
  deploy-production:
    name: ğŸ­ Deploy to Production
    needs: [test, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'alpha') && !contains(github.ref, 'beta')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: ğŸ” Setup Android Signing
      run: |
        echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/keystore.jks
        echo "storePassword=${{ secrets.KEYSTORE_PASSWORD }}" >> android/key.properties
        echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
        echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
        echo "storeFile=keystore.jks" >> android/key.properties
        
    - name: ğŸ“¦ Get Dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build AAB for Production
      run: flutter build appbundle --release \
        --dart-define=SUPABASE_URL="${{ env.SUPABASE_URL }}" \
        --dart-define=SUPABASE_ANON_KEY="${{ env.SUPABASE_ANON_KEY }}"
        
    - name: ğŸª Upload to Google Play Production
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        packageName: com.sabo_arena.app
        releaseFiles: build/app/outputs/bundle/release/app-release.aab
        track: production
        status: draft # Requires manual review